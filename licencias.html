<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gesti√≥n de Licencias</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .modulo { margin-bottom: 40px; }
    label, input, select, button { display: block; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .feedback { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Panel de Licencias</h1>

  <!-- üîß Bloque 1: Generar licencia individual -->
<section id="crear-licencia-individual" class="modulo">
  <h2>Generar Licencia Individual</h2>
  <form id="formLicenciaIndividual">
    <label for="tipo">Tipo de licencia:</label>
    <select id="tipo" required>
      <option value="bloqueo_total">Bloqueo total</option>
      <option value="navegacion_limitada">Navegaci√≥n limitada</option>
    </select>

    <label for="imei">IMEI del dispositivo:</label>
    <input type="text" id="imei" required maxlength="20" />

    <label for="selector_comercio">Comercio asignado:</label>
    <select id="selector_comercio" required>
      <option value="">Selecciona un comercio</option>
    </select>

    <button type="submit">Crear licencia</button>
  </form>

  <div id="feedbackLicenciaIndividual" class="feedback"></div>
</section>

<script>
  function generarToken() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    return Array.from({ length: 8 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
  }

  document.getElementById('formLicenciaIndividual').addEventListener('submit', async (e) => {
    e.preventDefault();
    const tipo = document.getElementById('tipo').value;
    const imei = document.getElementById('imei').value.trim();
    const comercio_id = document.getElementById('selector_comercio').value;

    const token = generarToken();
    const link_instalacion = `https://tudominio.com/instalar?token=${token}`;

    const { data, error } = await supabase
      .from('licencias')
      .insert([{
        tipo,
        imei,
        comercio_id,
        estado: 'activa',
        fecha_creacion: new Date().toISOString(),
        token,
        link_instalacion
      }]);

    const feedback1 = document.getElementById('feedbackLicenciaIndividual');

    if (error) {
      feedback1.textContent = '‚ùå Error: ' + error.message;
      feedback1.style.color = 'red';
    } else {
      feedback1.innerHTML = `
        ‚úÖ Licencia creada con ID: ${data[0].id}<br>
        üîó <a href="${link_instalacion}" target="_blank">${link_instalacion}</a><br>
        üì± <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(link_instalacion)}" alt="QR de instalaci√≥n" />
      `;
      feedback1.style.color = 'green';
      e.target.reset();
      cargarLicencias();
    }
  });
</script>

  <!-- üì¶ Bloque 2: Generar lote de licencias -->
<section id="crear-lote-licencias" class="modulo">
  <h2>Generar Lote de Licencias</h2>
  <form id="formLoteLicencias">
    <label for="cantidad">Cantidad:</label>
    <input type="number" id="cantidad" required min="1" max="1000" />

    <label for="tipoLote">Tipo de licencia:</label>
    <select id="tipoLote" required>
      <option value="bloqueo_total">Bloqueo total</option>
      <option value="navegacion_limitada">Navegaci√≥n limitada</option>
    </select>

    <label for="selector_comercio_lote">Comercio asignado:</label>
    <select id="selector_comercio_lote" required>
      <option value="">Selecciona un comercio</option>
    </select>

    <button type="submit">Crear lote</button>
  </form>

  <div id="feedbackLoteLicencias" class="feedback"></div>
</section>

<script>
  function generarToken() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    return Array.from({ length: 8 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
  }

  document.getElementById('formLoteLicencias').addEventListener('submit', async (e) => {
    e.preventDefault();
    const cantidad = parseInt(document.getElementById('cantidad').value);
    const tipo = document.getElementById('tipoLote').value;
    const comercio_id = document.getElementById('selector_comercio_lote').value;

    const lote = Array.from({ length: cantidad }, () => {
      const token = generarToken();
      const link_instalacion = `https://tudominio.com/instalar?token=${token}`;
      return {
        tipo,
        imei: null,
        comercio_id,
        estado: 'activa',
        fecha_creacion: new Date().toISOString(),
        token,
        link_instalacion
      };
    });

    const { error } = await supabase.from('licencias').insert(lote);

    const feedback2 = document.getElementById('feedbackLoteLicencias');

    if (error) {
      feedback2.textContent = '‚ùå Error: ' + error.message;
      feedback2.style.color = 'red';
    } else {
      feedback2.innerHTML = `‚úÖ Lote de ${cantidad} licencias creado con tokens √∫nicos.<br>Ya puedes verlas en la tabla.`;
      feedback2.style.color = 'green';
      e.target.reset();
      cargarLicencias();
    }
  });
</script>

  <!-- üìä Bloque 3: Tabla de licencias -->
  <section id="tabla-licencias" class="modulo">
    <h2>Licencias Existentes</h2>
    <label for="filtroEstado">Filtrar por estado:</label>
<select id="filtroEstado">
  <option value="todas">Todas</option>
  <option value="activa">Activas</option>
  <option value="inactiva">Inactivas</option>
</select>
    <table id="tablaLicencias">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tipo</th>
          <th>IMEI</th>
          <th>Comercio</th>
          <th>Estado</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- üîå Script funcional -->
  <script>
    const supabase = supabase.createClient(
      'https://xhqhtzrcohovylcxibkf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhocWh0enJjb2hvdnlsY3hpYmtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4Njg3NTEsImV4cCI6MjA3MDQ0NDc1MX0.aTAOD-m3n2n6MAg1Cx2lDOPAD4jT2z4bcQXjxZwgllI'
    );

    const feedback1 = document.getElementById('feedbackLicenciaIndividual');
    const feedback2 = document.getElementById('feedbackLoteLicencias');
    const tablaBody = document.querySelector('#tablaLicencias tbody');

    async function cargarSelectorComercios() {
      const { data, error } = await supabase.from('comercios').select('id, nombre').eq('estado', 'activo');
      const selector1 = document.getElementById('selector_comercio');
      const selector2 = document.getElementById('selector_comercio_lote');
      selector1.innerHTML = '<option value="">Selecciona un comercio</option>';
      selector2.innerHTML = '<option value="">Selecciona un comercio</option>';

      if (error) return console.error('Error al cargar comercios:', error.message);

      data.forEach(c => {
        const option1 = document.createElement('option');
        option1.value = c.id;
        option1.textContent = c.nombre;
        selector1.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = c.id;
        option2.textContent = c.nombre;
        selector2.appendChild(option2);
      });
    }

    document.getElementById('formLicenciaIndividual').addEventListener('submit', async (e) => {
      e.preventDefault();
      const tipo = document.getElementById('tipo').value;
      const imei = document.getElementById('imei').value.trim();
      const comercio_id = document.getElementById('selector_comercio').value;

      const { data, error } = await supabase
        .from('licencias')
        .insert([{ tipo, imei, comercio_id, estado: 'activa', fecha_creacion: new Date().toISOString() }]);

      if (error) {
        feedback1.textContent = '‚ùå Error: ' + error.message;
        feedback1.style.color = 'red';
      } else {
        feedback1.textContent = '‚úÖ Licencia creada con ID: ' + data[0].id;
        feedback1.style.color = 'green';
        e.target.reset();
        cargarLicencias();
      }
    });

    document.getElementById('formLoteLicencias').addEventListener('submit', async (e) => {
      e.preventDefault();
      const cantidad = parseInt(document.getElementById('cantidad').value);
      const tipo = document.getElementById('tipoLote').value;
      const comercio_id = document.getElementById('selector_comercio_lote').value;

      const lote = Array.from({ length: cantidad }, () => ({
        tipo, imei: null, comercio_id, estado: 'activa', fecha_creacion: new Date().toISOString()
      }));

      const { error } = await supabase.from('licencias').insert(lote);

      if (error) {
        feedback2.textContent = '‚ùå Error: ' + error.message;
        feedback2.style.color = 'red';
      } else {
        feedback2.textContent = `‚úÖ Lote de ${cantidad} licencias creado`;
        feedback2.style.color = 'green';
        e.target.reset();
        cargarLicencias();
      }
    });

    async function cargarLicencias() {
  const estadoSeleccionado = document.getElementById('filtroEstado').value;
  let query = supabase
    .from('licencias')
    .select('id, tipo, imei, estado, fecha_creacion, comercios(nombre)')
    .order('fecha_creacion', { ascending: false })
    .limit(100);

  if (estadoSeleccionado !== 'todas') {
    query = query.eq('estado', estadoSeleccionado);
  }

  const { data, error } = await query;

  tablaBody.innerHTML = '';
  if (data) {
    data.forEach(lic => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${lic.id}</td>
        <td>${lic.tipo}</td>
        <td>${lic.imei || '-'}</td>
        <td>${lic.comercios?.nombre || '-'}</td>
        <td>${lic.estado}</td>
        <td>${new Date(lic.fecha_creacion).toLocaleString()}</td>
      `;
      tablaBody.appendChild(row);
    });
  }
        }

    cargarSelectorComercios();
    cargarLicencias();
    document.getElementById('filtroEstado').addEventListener('change', cargarLicencias);
  </script>
</body>
  </html>
