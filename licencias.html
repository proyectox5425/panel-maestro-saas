<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GestiÃ³n de Licencias</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .modulo { margin-bottom: 40px; }
    label, input, select, button { display: block; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .feedback { margin-top: 10px; font-weight: bold; }
  </style>
</head>

<body>
  <h1>Panel de Licencias</h1>

  <!-- ðŸ”§ Bloque 1: Generar licencia individual -->
  <section id="crear-licencia-individual" class="modulo">
    <h2>Generar Licencia Individual</h2>
    <form id="formLicenciaIndividual">
      <label for="tipo">Tipo de licencia:</label>
      <select id="tipo" required>
        <option value="bloqueo_total">Bloqueo total</option>
        <option value="navegacion_limitada">NavegaciÃ³n limitada</option>
      </select>

      <label for="selector_comercio">Comercio asignado:</label>
      <select id="selector_comercio" required>
        <option value="">Selecciona un comercio</option>
      </select>

      <button type="submit">Crear licencia</button>
    </form>

    <div id="feedbackLicenciaIndividual" class="feedback"></div>
  </section>

  <!-- ðŸ“¦ Bloque 2: Generar lote de licencias -->
  <section id="crear-lote-licencias" class="modulo">
    <h2>Generar Lote de Licencias</h2>
    <form id="formLoteLicencias">
      <label for="cantidad">Cantidad:</label>
      <input type="number" id="cantidad" required min="1" max="1000" />

      <label for="tipoLote">Tipo de licencia:</label>
      <select id="tipoLote" required>
        <option value="bloqueo_total">Bloqueo total</option>
        <option value="navegacion_limitada">NavegaciÃ³n limitada</option>
      </select>

<label for="nombreLote">Nombre del lote:</label>
<input type="text" id="nombreLote" required />

      <label for="selector_comercio_lote">Comercio asignado:</label>
      <select id="selector_comercio_lote" required>
        <option value="">Selecciona un comercio</option>
      </select>

      <button type="submit">Crear lote</button>
    </form>

    <div id="feedbackLoteLicencias" class="feedback"></div>
  </section>

  <!-- ðŸ“Š Bloque 3: Tabla de licencias -->
  <section id="tabla-licencias" class="modulo">
    <h2>Licencias Existentes</h2>
    <label for="filtroEstado">Filtrar por estado:</label>
    <select id="filtroEstado">
      <option value="todas">Todas</option>
      <option value="disponible">Disponibles</option>
      <option value="activa">Activas</option>
      <option value="inactiva">Inactivas</option>
      <option value="bloqueado">Bloqueadas</option>
    </select>
    <table id="tablaLicencias">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tipo</th>
          <th>IMEI</th>
          <th>Comercio</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Token</th>
          <th>Link</th>
          <th>Lote</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ðŸ§­ Bloque: Dispositivos Instalados -->
  <section id="dispositivos-instalados" class="modulo">
    <h2>Dispositivos Instalados</h2>
    <table id="tablaInstalados">
      <thead>
        <tr>
          <th>IMEI</th>
          <th>Token</th>
          <th>Tipo</th>
          <th>Comercio</th>
          <th>Estado</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ðŸ’³ Bloque: Control financiero -->
  <section id="control-financiero" class="modulo">
    <h2>Control Financiero</h2>
    <form id="formFinanciero">
      <label for="imeiFinanciero">IMEI del dispositivo:</label>
      <input type="text" id="imeiFinanciero" required maxlength="20" />

      <label for="accionFinanciera">AcciÃ³n:</label>
      <select id="accionFinanciera" required>
        <option value="bloquear">Simular mora (bloquear)</option>
        <option value="desbloquear">Registrar pago (desbloquear)</option>
        <option value="revocar">Revocar licencia</option>
      </select>

      <button type="submit">Ejecutar acciÃ³n</button>
    </form>

    <div id="feedbackFinanciero" class="feedback"></div>
  </section>

<!-- ðŸ§± Bloque: Lotes Institucionales -->
<section id="tabla-lotes" class="modulo">
  <h2>Lotes Institucionales</h2>
  <table id="tablaLotes">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Comercio</th>
        <th>Tipo</th>
        <th>Cantidad</th>
        <th>Fecha</th>
        <th>ID</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  const supabase = createClient(
    'https://xhqhtzrcohovylcxibkf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhocWh0enJjb2hvdnlsY3hpYmtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4Njg3NTEsImV4cCI6MjA3MDQ0NDc1MX0.aTAOD-m3n2n6MAg1Cx2lDOPAD4jT2z4bcQXjxZwgllI'
  )

  const selectorComercio = document.getElementById('selector_comercio')
  const selectorComercioLote = document.getElementById('selector_comercio_lote')
  const tablaLicencias = document.getElementById('tablaLicencias').querySelector('tbody')
  const tablaInstalados = document.getElementById('tablaInstalados').querySelector('tbody')
  const filtroEstado = document.getElementById('filtroEstado')

  let comercios = []

  async function cargarComercios() {
    const { data, error } = await supabase.from('comercios').select('id,nombre')
    if (error) return console.error('Error al cargar comercios:', error)
    comercios = data
    data.forEach(comercio => {
      const option1 = document.createElement('option')
      option1.value = comercio.id
      option1.textContent = comercio.nombre
      selectorComercio.appendChild(option1)

      const option2 = document.createElement('option')
      option2.value = comercio.id
      option2.textContent = comercio.nombre
      selectorComercioLote.appendChild(option2)
    })
  }

  async function crearLicenciaIndividual(event) {
    event.preventDefault()
    const tipo = document.getElementById('tipo').value
    const comercioId = selectorComercio.value

    const { data, error } = await supabase
      .from('licencias')
      .insert([{ tipo, comercio_id: comercioId }])
      .select()

    const feedback = document.getElementById('feedbackLicenciaIndividual')
    if (error) {
      feedback.textContent = 'Error al crear licencia: ' + error.message
    } else {
      feedback.textContent = 'Licencia creada con ID: ' + data[0].id
      cargarLicencias()
    }
  }

  async function crearLoteLicencias(event) {
  event.preventDefault()
  const cantidad = parseInt(document.getElementById('cantidad').value)
  const tipo = document.getElementById('tipoLote').value
  const comercioId = selectorComercioLote.value
  const nombreLote = document.getElementById('nombreLote').value
  const fecha = new Date().toISOString()

  // Paso 1: crear el lote institucional
  const { data: loteData, error: errorLote } = await supabase
    .from('lotes')
    .insert([{
      nombre: nombreLote,
      comercio_id: comercioId,
      cantidad,
      creado_en: fecha
    }])
    .select()

  if (errorLote || !loteData?.[0]?.id) {
    feedbackLoteLicencias.textContent = 'âŒ Error al crear lote: ' + errorLote.message
    return
  }

  const loteId = loteData[0].id

  // Paso 2: generar las licencias vinculadas al lote
  const licencias = Array.from({ length: cantidad }, () => ({
    tipo,
    comercio_id: comercioId,
    token: crypto.randomUUID().slice(0, 8),
    estado: 'disponible',
    creado_en: fecha,
    generado_por_panel: 'maestro',
    lote_id: loteId
  }))

  const { error: errorLicencias } = await supabase
    .from('licencias')
    .insert(licencias)

  if (errorLicencias) {
    feedbackLoteLicencias.textContent = 'âŒ Error al insertar licencias: ' + errorLicencias.message
    return
  }

  feedbackLoteLicencias.textContent = `âœ… Se creÃ³ el lote "${nombreLote}" y se insertaron ${cantidad} licencias`
  cargarLicencias()
}
  }

  async function cargarLicencias() {
    const estado = filtroEstado.value
    let query = supabase.from('licencias').select('*').order('id', { ascending: false })

    if (estado !== 'todas') {
      query = query.eq('estado', estado)
    }

    const { data, error } = await query
    if (error) return console.error('Error al cargar licencias:', error)

    tablaLicencias.innerHTML = ''
    data.forEach(licencia => {
      const comercio = comercios.find(c => c.id === licencia.comercio_id)
      const nombreComercio = comercio ? comercio.nombre : 'â€”'

      const fila = document.createElement('tr')
      fila.innerHTML = `
  <td>${licencia.id}</td>
  <td>${licencia.tipo}</td>
  <td>${licencia.imei || 'â€”'}</td>
  <td>${nombreComercio}</td>
  <td>${licencia.estado}</td>
  <td>${licencia.fecha || 'â€”'}</td>
  <td>${licencia.token || 'â€”'}</td>
  <td>${licencia.token ? `<a href="https://panel.com/licencia/${licencia.token}" target="_blank">Ver</a>` : 'â€”'}</td>
  <td>${licencia.lote_id || 'â€”'}</td>
`
      tablaLicencias.appendChild(fila)
    })
  }

  async function cargarInstalados() {
    const { data, error } = await supabase
      .from('licencias')
      .select('*')
      .eq('estado', 'activa')

    if (error) return console.error('Error al cargar instalados:', error)

    tablaInstalados.innerHTML = ''
    data.forEach(licencia => {
      const comercio = comercios.find(c => c.id === licencia.comercio_id)
      const nombreComercio = comercio ? comercio.nombre : 'â€”'

      const fila = document.createElement('tr')
      fila.innerHTML = `
        <td>${licencia.imei}</td>
        <td>${licencia.token}</td>
        <td>${licencia.tipo}</td>
        <td>${nombreComercio}</td>
        <td>${licencia.estado}</td>
        <td>${licencia.fecha}</td>
      `
      tablaInstalados.appendChild(fila)
    })
  }

async function cargarLotes() {
  const tablaLotes = document.getElementById('tablaLotes').querySelector('tbody')
  const { data, error } = await supabase
    .from('lotes')
    .select('*')
    .order('creado_en', { ascending: false })

  if (error) return console.error('Error al cargar lotes:', error)

  tablaLotes.innerHTML = ''
  data.forEach(lote => {
    const comercio = comercios.find(c => c.id === lote.comercio_id)
    const nombreComercio = comercio ? comercio.nombre : 'â€”'

    const fila = document.createElement('tr')
    fila.innerHTML = `
      <td>${lote.nombre}</td>
      <td>${nombreComercio}</td>
      <td>${lote.tipo || 'â€”'}</td>
      <td>${lote.cantidad}</td>
      <td>${lote.creado_en?.split('T')[0]}</td>
      <td>${lote.id}</td>
    `
    tablaLotes.appendChild(fila)
  })
}

  async function ejecutarAccionFinanciera(event) {
    event.preventDefault()
    const imei = document.getElementById('imeiFinanciero').value
    const accion = document.getElementById('accionFinanciera').value

    let cambios = {}
    if (accion === 'bloquear') cambios.estado = 'bloqueado'
    if (accion === 'desbloquear') cambios.estado = 'activa'
    if (accion === 'revocar') cambios.estado = 'inactiva'

    const { error } = await supabase
      .from('licencias')
      .update(cambios)
      .eq('imei', imei)

    const feedback = document.getElementById('feedbackFinanciero')
    if (error) {
      feedback.textContent = 'Error: ' + error.message
    } else {
      feedback.textContent = 'AcciÃ³n ejecutada correctamente'
      cargarLicencias()
      cargarInstalados()
    }
  }

  document.getElementById('formLicenciaIndividual').addEventListener('submit', crearLicenciaIndividual)
  document.getElementById('formLoteLicencias').addEventListener('submit', crearLoteLicencias)
  document.getElementById('formFinanciero').addEventListener('submit', ejecutarAccionFinanciera)
  filtroEstado.addEventListener('change', cargarLicencias)

  cargarComercios().then(() => {
  cargarLicencias()
  cargarInstalados()
  cargarLotes()
})
</script>
</body>
</html>