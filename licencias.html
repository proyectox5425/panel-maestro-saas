<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gesti√≥n de Licencias</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .modulo { margin-bottom: 40px; }
    label, input, select, button { display: block; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .feedback { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Panel de Licencias</h1>

  <!-- üîß Bloque 1: Generar licencia individual -->
<section id="crear-licencia-individual" class="modulo">
  <h2>Generar Licencia Individual</h2>
  <form id="formLicenciaIndividual">
    <label for="tipo">Tipo de licencia:</label>
    <select id="tipo" required>
      <option value="bloqueo_total">Bloqueo total</option>
      <option value="navegacion_limitada">Navegaci√≥n limitada</option>
    </select>

    <label for="selector_comercio">Comercio asignado:</label>
    <select id="selector_comercio" required>
      <option value="">Selecciona un comercio</option>
    </select>

    <button type="submit">Crear licencia</button>
  </form>

  <div id="feedbackLicenciaIndividual" class="feedback"></div>
</section>

<!-- üì¶ Bloque 2: Generar lote de licencias -->
<section id="crear-lote-licencias" class="modulo">
  <h2>Generar Lote de Licencias</h2>
  <form id="formLoteLicencias">
    <label for="cantidad">Cantidad:</label>
    <input type="number" id="cantidad" required min="1" max="1000" />

    <label for="tipoLote">Tipo de licencia:</label>
    <select id="tipoLote" required>
      <option value="bloqueo_total">Bloqueo total</option>
      <option value="navegacion_limitada">Navegaci√≥n limitada</option>
    </select>

    <label for="selector_comercio_lote">Comercio asignado:</label>
    <select id="selector_comercio_lote" required>
      <option value="">Selecciona un comercio</option>
    </select>

    <button type="submit">Crear lote</button>
  </form>

  <div id="feedbackLoteLicencias" class="feedback"></div>
</section>

<!-- üìä Bloque 3: Tabla de licencias -->
<section id="tabla-licencias" class="modulo">
  <h2>Licencias Existentes</h2>
  <label for="filtroEstado">Filtrar por estado:</label>
  <select id="filtroEstado">
    <option value="todas">Todas</option>
    <option value="disponible">Disponibles</option>
    <option value="activa">Activas</option>
    <option value="inactiva">Inactivas</option>
    <option value="bloqueado">Bloqueadas</option>
  </select>
  <table id="tablaLicencias">
    <thead>
      <tr>
        <th>ID</th>
        <th>Tipo</th>
        <th>IMEI</th>
        <th>Comercio</th>
        <th>Estado</th>
        <th>Fecha</th>
        <th>Token</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- üß≠ Bloque: Dispositivos Instalados -->
<section id="dispositivos-instalados" class="modulo">
  <h2>Dispositivos Instalados</h2>
  <table id="tablaInstalados">
    <thead>
      <tr>
        <th>IMEI</th>
        <th>Token</th>
        <th>Tipo</th>
        <th>Comercio</th>
        <th>Estado</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- üí≥ Bloque: Control financiero -->
<section id="control-financiero" class="modulo">
  <h2>Control Financiero</h2>
  <form id="formFinanciero">
    <label for="imeiFinanciero">IMEI del dispositivo:</label>
    <input type="text" id="imeiFinanciero" required maxlength="20" />

    <label for="accionFinanciera">Acci√≥n:</label>
    <select id="accionFinanciera" required>
      <option value="bloquear">Simular mora (bloquear)</option>
      <option value="desbloquear">Registrar pago (desbloquear)</option>
      <option value="revocar">Revocar licencia</option>
    </select>

    <button type="submit">Ejecutar acci√≥n</button>
  </form>

  <div id="feedbackFinanciero" class="feedback"></div>
</section>

<script>
const supabase = supabase.createClient(
  'https://xhqhtzrcohovylcxibkf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhocWh0enJjb2hvdnlsY3hpYmtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4Njg3NTEsImV4cCI6MjA3MDQ0NDc1MX0.aTAOD-m3n2n6MAg1Cx2lDOPAD4jT2z4bcQXjxZwgllI'
);

function generarToken() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({ length: 8 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
}

async function cargarSelectorComercios() {
  const { data, error } = await supabase.from('comercios').select('id, nombre').eq('activo', true);
  const selector1 = document.getElementById('selector_comercio');
  const selector2 = document.getElementById('selector_comercio_lote');
  selector1.innerHTML = '<option value="">Selecciona un comercio</option>';
  selector2.innerHTML = '<option value="">Selecciona un comercio</option>';
  if (error) return console.error('Error al cargar comercios:', error.message);
  data.forEach(c => {
    const opt1 = document.createElement('option');
    opt1.value = c.id;
    opt1.textContent = c.nombre;
    selector1.appendChild(opt1);
    const opt2 = document.createElement('option');
    opt2.value = c.id;
    opt2.textContent = c.nombre;
    selector2.appendChild(opt2);
  });
}

document.getElementById('formLicenciaIndividual').addEventListener('submit', async (e) => {
  e.preventDefault();
  const tipo = document.getElementById('tipo').value;
  const comercio_id = document.getElementById('selector_comercio').value;
  const token = generarToken();
  const link_instalacion = `https://tudominio.com/instalar?token=${token}`;
  const { data, error } = await supabase.from('licencias').insert([{
    tipo,
    imei: null,
    comercio_id,
    estado: 'disponible',
    fecha_creacion: new Date().toISOString(),
    token,
    link_instalacion
  }]);
  const feedback = document.getElementById('feedbackLicenciaIndividual');
  if (error) {
    feedback.textContent = '‚ùå Error: ' + error.message;
    feedback.style.color = 'red';
  } else {
    await supabase.from('eventos_dispositivo').insert({
      tipo_evento: 'licencia_generada',
      licencia_id: data[0].id,
      fecha: new Date().toISOString()
    });
    feedback.innerHTML = `
      ‚úÖ Licencia creada con ID: ${data[0].id}<br>
      üîó <a href="${link_instalacion}" target="_blank">${link_instalacion}</a><br>
      üì± <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(link_instalacion)}" alt="QR de instalaci√≥n" />
    `;
    feedback.style.color = 'green';
    e.target.reset();
    cargarLicencias();
  }
});

document.getElementById('formLoteLicencias').addEventListener('submit', async (e) => {
  e.preventDefault();
  const cantidad = parseInt(document.getElementById('cantidad').value);
  const tipo = document.getElementById('tipoLote').value;
  const comercio_id = document.getElementById('selector_comercio_lote').value;
  const lote = [];
  for (let i = 0; i < cantidad; i++) {
    const token = generarToken();
    const link = `https://tudominio.com/instalar?token=${token}`;
    lote.push({
      tipo,
      imei: null,
      comercio_id,
      estado: 'disponible',
      fecha_creacion: new Date().toISOString(),
      token,
      link_instalacion: link
    });
  }
  const { data, error } = await supabase.from('licencias').insert(lote);
  const feedback = document.getElementById('feedbackLoteLicencias');
  if (error) {
    feedback.textContent = '‚ùå Error: ' + error.message;
    feedback.style.color = 'red';
  } else {
    for (const lic of data) {
      await supabase.from('eventos_dispositivo').insert({
        tipo_evento: 'licencia_generada',
        licencia_id: lic.id,
        fecha: new Date().toISOString()
      });
    }
    feedback.textContent = `‚úÖ Lote de ${cantidad} licencias creado`;
    feedback.style.color = 'green';
    e.target.reset();
    cargarLicencias();
  }
});

async function cargarLicencias() {
  const estado = document.getElementById('filtroEstado').value;
  let query = supabase.from('licencias').select('id, tipo, imei, estado, fecha_creacion, token, link_instalacion, comercios(nombre)').order('fecha_creacion', { ascending: false }).limit(100);
  if (estado !== 'todas') query = query.eq('estado', estado);
  const { data, error } = await query;
  const tbody = document.querySelector('#tablaLicencias tbody');
  tbody.innerHTML = '';
  if (data) {
    data.forEach(lic => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${lic.id}</td>
        <td>${lic.tipo}</td>
        <td>${lic.imei || '-'}</td>
        <td>${lic.comercios?.nombre || '-'}</td>
        <td>${lic.estado}</td>
        <td>${new Date(lic.fecha_creacion).toLocaleString()}</td>
        <td>${lic.token}</td>
        <td><a href="${lic.link_instalacion}" target="_blank">Instalar</a></td>
      `;
      tbody.appendChild(tr);
    });
  }
}

document.getElementById('filtroEstado').addEventListener('change', cargarLicencias);

async function cargarInstalados() {
  const { data, error } = await supabase
    .from('licencias')
    .select('imei, token, tipo, estado, fecha_creacion, comercios(nombre)')
    .not('imei', 'is', null)
    .order('fecha_creacion', { ascending: false })
    .limit(100);
  const tbody = document.querySelector('#tablaInstalados tbody');
  tbody.innerHTML = '';
  if (data) {
    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.imei}</td>
        <td>${row.token}</td>
        <td>${row.tipo}</td>
        <td>${row.comercios?.nombre || '-'}</td>
        <td>${row.estado}</td>
        <td>${new Date(row.fecha_creacion).toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }
}

document.getElementById('formFinanciero').addEventListener('submit', async (e) => {
  e.preventDefault();
  const imei = document.getElementById('imeiFinanciero').value.trim();
  const accion = document.getElementById('accionFinanciera').value;
  const feedback = document.getElementById('feedbackFinanciero');
  const { data: licencia } = await supabase.from('licencias').select('id').eq('imei', imei).single();
  if (!licencia) {
    feedback.textContent = '‚ùå IMEI no encontrado';
    feedback.style.color = 'red';
    return;
  }
  let nuevoEstado = accion === 'bloquear' ? 'bloqueado' : accion === 'desbloquear' ? 'activa' : 'revocada';
  const { error } = await supabase.from('licencias').update({ estado: nuevoEstado }).eq('imei', imei);
  if (error) {
    feedback.textContent = '‚ùå Error: ' + error.message;
    feedback.style.color = 'red';
  } else {
    await supabase.from('eventos_dispositivo').insert({
      imei,
      tipo_evento: accion,
      fecha: new Date().toISOString()
    });
    feedback.textContent = `‚úÖ Acci√≥n ejecutada: ${accion}`;
    feedback.style.color = 'green';
e.target.reset();
    cargarLicencias();
    cargarInstalados();
  }
});

async function verHistorial() {
  const imei = document.getElementById('imeiHistorial').value.trim();
  const { data, error } = await supabase
    .from('eventos_dispositivo')
    .select('fecha, tipo_evento')
    .eq('imei', imei)
    .order('fecha', { ascending: false });

  const tbody = document.getElementById('tablaHistorial');
  tbody.innerHTML = '';

  if (data) {
    data.forEach(ev => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(ev.fecha).toLocaleString()}</td><td>${ev.tipo_evento}</td>`;
      tbody.appendChild(tr);
    });
  }
}

// Inicializaci√≥n
cargarSelectorComercios();
cargarLicencias();
cargarInstalados();
</script>

<!-- üìú Historial de eventos -->
<section id="historial-eventos" class="modulo">
  <h2>Historial de Eventos</h2>
  <input type="text" id="imeiHistorial" placeholder="IMEI a consultar" maxlength="20" />
  <button onclick="verHistorial()">Ver historial</button>
  <table>
    <thead><tr><th>Fecha</th><th>Evento</th></tr></thead>
    <tbody id="tablaHistorial"></tbody>
  </table>
</section>

</body>
</html>