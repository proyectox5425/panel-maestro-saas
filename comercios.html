<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Maestro ‚Äì Comercios</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    input, select, button { margin: 0.3rem; padding: 0.4rem; }
    .form-block { margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>üß© Gesti√≥n de Comercios</h2>
  <p>üë§ Usuario maestro: <span id="usuarioActivo"></span></p>

  <div class="form-block">
    <input type="hidden" id="comercio_id" />
    <input type="text" id="nombre" placeholder="Nombre del comercio" />
    <input type="text" id="rif" placeholder="RIF (ej. J-12345678-9)" />
    <input type="email" id="correo" placeholder="Correo institucional del comercio" />
<input type="number" id="cantidad_licencias" placeholder="Licencias iniciales" min="1" />
    <select id="estado">
      <option value="">-- Estado --</option>
      <option value="activo">Activo</option>
      <option value="inactivo">Inactivo</option>
    </select>
    <button id="guardarBtn">Guardar</button>
  </div>

  <table id="tabla_comercios">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>RIF</th>
        <th>Estado</th>
        <th>Correo</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<div id="licenciasBlock" class="form-block" style="display:none;">
  <h3>üé´ Licencias asignadas</h3>
  <table id="tabla_licencias">
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Total</th>
        <th>Consumidas</th>
        <th>Disponibles</th>
        <th>Tolerancia (d√≠as)</th>
        <th>Creado en</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      'https://xhqhtzrcohovylcxibkf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhocWh0enJjb2hvdnlsY3hpYmtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4Njg3NTEsImV4cCI6MjA3MDQ0NDc1MX0.aTAOD-m3n2n6MAg1Cx2lDOPAD4jT2z4bcQXjxZwgllI'
    );

    const usuarioMaestro = localStorage.getItem("correo") ?? "maestro";
    document.getElementById("usuarioActivo").textContent = usuarioMaestro;

    async function cargarComercios() {
      const { data, error } = await supabase.from('comercios').select('*');
      const tbody = document.querySelector('#tabla_comercios tbody');
      tbody.innerHTML = '';
      if (error) return;
      data.forEach(c => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${c.id}</td>
          <td>${c.nombre}</td>
          <td>${c.rif}</td>
          <td>${c.activo ? 'Activo' : 'Inactivo'}</td>
          <td>${c.correo}</td>
          <td>
            <button data-editar='${JSON.stringify(c)}'>Editar</button>
            <button data-eliminar='${c.id}'>Eliminar</button>
          </td>
        `;
        tbody.appendChild(fila);
      });
    }

    function editar(c) {
  document.getElementById('comercio_id').value = c.id;
  document.getElementById('nombre').value = c.nombre;
  document.getElementById('rif').value = c.rif;
  document.getElementById('estado').value = c.activo ? 'activo' : 'inactivo';
  document.getElementById('correo').value = c.correo;
  cargarLicencias(c.id);
}

async function cargarLicencias(comercio_id) {
  const { data, error } = await supabase
    .from('lotes_licencias')
    .select('*')
    .eq('comercio_id', comercio_id)
    .order('creado_en', { ascending: false });

  const tbody = document.querySelector('#tabla_licencias tbody');
  tbody.innerHTML = '';
  if (error || !data || data.length === 0) {
    document.getElementById('licenciasBlock').style.display = 'none';
    return;
  }

  data.forEach(l => {
    const disponibles = l.cantidad_total - l.cantidad_consumida;
    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td>${l.tipo}</td>
      <td>${l.cantidad_total}</td>
      <td>${l.cantidad_consumida}</td>
      <td>${disponibles}</td>
      <td>${l.tolerancia_dias}</td>
      <td>${new Date(l.creado_en).toLocaleDateString()}</td>
    `;
    tbody.appendChild(fila);
  });

  document.getElementById('licenciasBlock').style.display = 'block';
}

    async function guardarComercio() {
      const id = document.getElementById('comercio_id').value;
      const nombre = document.getElementById('nombre').value.trim();
      const rif = document.getElementById('rif').value.trim();
      const estado = document.getElementById('estado').value;
      const correo = document.getElementById('correo').value.trim();
      const activo = estado === 'activo';

      if (!nombre || !rif || !correo || !estado) return alert('‚ùå Completa todos los campos');
      if (!rif.match(/^[JGVEP]-\d{8}-\d$/)) return alert('‚ùå RIF inv√°lido');
      if (!correo.includes('@')) return alert('‚ùå Correo inv√°lido');

      const { data: existentes } = await supabase.from('comercios').select('id').eq('rif', rif);
      if (!id && existentes.length > 0) return alert('‚ùå RIF duplicado');

      let comercio_id = id;
      let claveGenerada = null;

      if (id) {
        const { error } = await supabase.from('comercios').update({ nombre, rif, correo, activo }).eq('id', id);
        if (error) return alert('‚ùå Error al actualizar comercio');
      } else {
        const { data, error } = await supabase.from('comercios').insert({ nombre, rif, correo, activo }).select();
        if (error || !data || !data[0]) return alert('‚ùå Error al crear comercio');
        comercio_id = data[0].id;

const cantidadLicencias = parseInt(document.getElementById('cantidad_licencias').value);
if (!cantidadLicencias || cantidadLicencias < 1) return alert('‚ùå Cantidad de licencias inv√°lida');

await supabase.from('lotes_licencias').insert({
  comercio_id,
  cantidad_total: cantidadLicencias,
  cantidad_consumida: 0,
  tipo: 'bloqueo_total',
  tolerancia_dias: 3,
  creado_en: new Date().toISOString()
});

        claveGenerada = Math.random().toString(36).slice(-8).toUpperCase();
        const { error: errorUsuario } = await supabase.from('usuarios_comercios').insert({
          comercio_id,
          correo,
          clave: claveGenerada
        });
        if (errorUsuario) return alert('‚ùå Error al crear usuario del comercio');
      }

      await supabase.from('eventos').insert({
  tipo: id ? 'comercio_editado' : 'comercio_creado',
  descripcion: `Comercio ${id ? 'editado' : 'creado'}: ${nombre}`,
  usuario: usuarioMaestro,
  origen: 'panel_maestro',
  creado_en: new Date().toISOString(),
  id_panel: 'comercios'
});

      alert("‚úÖ Comercio " + (id ? "editado" : "creado") + "\nCorreo: " + correo + (claveGenerada ? "\nClave: " + claveGenerada : ""));
      document.getElementById('comercio_id').value = '';
      document.getElementById('nombre').value = '';
      document.getElementById('rif').value = '';
      document.getElementById('correo').value = '';
      document.getElementById('estado').value = '';
document.getElementById('cantidad_licencias').value = '';
      cargarComercios();
    }

    async function eliminar(id) {
      if (confirm('¬øInhabilitar este comercio?')) {
        await supabase.from('comercios').update({ activo: false }).eq('id', id);
        await supabase.from('eventos').insert({
          tipo: 'comercio_inhabilitado',
          descripcion: `Comercio inhabilitado: ${id}`,
          usuario: usuarioMaestro,
          origen: 'panel_maestro',
          creado_en: new Date().toISOString(),
          id_panel: 'comercios'
        });
        cargarComercios();
      }
    }

    document.getElementById("guardarBtn").addEventListener("click", guardarComercio);

    document.getElementById("tabla_comercios").addEventListener("click", (e) => {
      if (e.target.dataset.editar) editar(JSON.parse(e.target.dataset.editar));
      if (e.target.dataset.eliminar) eliminar(e.target.dataset.eliminar);
    });

    cargarComercios();
  </script>
</body>
</html>
