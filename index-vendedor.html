<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Vendedor</title>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f9f9f9; }
    .section { margin-bottom: 2em; }
    input, select, button { display: block; margin: 0.5em 0; padding: 0.5em; width: 100%; }
    .error-msg { color: red; font-size: 0.9em; }
    .success-msg { color: green; font-size: 0.9em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
  </style>
</head>
<body>

  <!-- üîê Login institucional -->
  <div id="login-section" class="section">
    <h2>Ingreso Vendedor</h2>
    <input type="email" id="correo" placeholder="Correo institucional" />
    <input type="password" id="clave" placeholder="Clave de acceso" />
    <button onclick="loginVendedor()">Ingresar</button>
    <p id="login-error" class="error-msg"></p>
  </div>

  <!-- üì≤ Enrolamiento de dispositivo -->
  <div id="enrolamiento-section" class="section" style="display:none;">
    <h2>Enrolar Dispositivo</h2>

    <label for="imei">IMEI</label>
    <input type="text" id="imei" placeholder="IMEI del dispositivo" />

    <label for="cliente-nombre">Nombre del cliente</label>
    <input type="text" id="cliente-nombre" placeholder="Nombre completo" />

    <label for="cliente-cedula">C√©dula</label>
    <input type="text" id="cliente-cedula" placeholder="C√©dula de identidad" />

    <label for="cliente-telefono">Tel√©fono</label>
    <input type="text" id="cliente-telefono" placeholder="Tel√©fono m√≥vil" />

    <label for="modelo-select">Modelo del tel√©fono (cat√°logo)</label>
    <select id="modelo-select">
      <option value="">-- Seleccionar modelo --</option>
    </select>

    <label for="marca-manual">Marca (manual)</label>
    <input type="text" id="marca-manual" placeholder="Ej: Xiaomi" />

    <label for="modelo-manual">Modelo (manual)</label>
    <input type="text" id="modelo-manual" placeholder="Ej: Redmi Note 13" />

    <button onclick="enrolarDispositivo()">Registrar venta</button>
    <p id="enrolamiento-msg" class="success-msg"></p>
  </div>

  <!-- üìã Historial de ventas -->
  <div id="historial-section" class="section" style="display:none;">
    <h2>Historial de Ventas</h2>
    <table id="tabla-ventas">
      <thead>
        <tr>
          <th>IMEI</th>
          <th>Cliente</th>
          <th>Modelo</th>
          <th>Estado</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

<button onclick="cerrarSesion()" style="margin-top:1em; background:#e74c3c; color:white; border:none; padding:0.5em; border-radius:4px;">
  Cerrar sesi√≥n
</button>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

<!-- ‚úÖ Esperamos a que las librer√≠as est√©n cargadas -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const supabase = window.supabase.createClient(
      'https://xhqhtzrcohovylcxibkf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhocWh0enJjb2hvdnlsY3hpYmtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4Njg3NTEsImV4cCI6MjA3MDQ0NDc1MX0.aTAOD-m3n2n6MAg1Cx2lDOPAD4jT2z4bcQXjxZwgllI'
    );

    let vendedor_id = null;
    let comercio_id = null;

    async function loginVendedor() {
  const correo = document.getElementById('correo').value.trim();
  const clave = document.getElementById('clave').value.trim();
  const errorMsg = document.getElementById('login-error');

  const { data, error } = await supabase.rpc('validar_login_vendedor', { correo, clave });

  if (error || !data || data.length === 0) {
    errorMsg.textContent = "Credenciales inv√°lidas o vendedor inactivo.";
    return;
  }

  vendedor_id = data[0].id;
  comercio_id = data[0].comercio_id;

  document.getElementById('login-section').style.display = 'none';
  document.getElementById('enrolamiento-section').style.display = 'block';
  document.getElementById('historial-section').style.display = 'block';

  cargarCatalogo();
  cargarHistorial();
}

    async function cargarCatalogo() {
  const { data, error } = await supabase.rpc('obtener_catalogo', { comercio_id });

  if (error || !data) return;

  const select = document.getElementById('modelo-select');
  select.innerHTML = '<option value="">-- Seleccionar modelo --</option>';
  data.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.id;
    opt.textContent = `${m.marca} ${m.modelo}`;
    select.appendChild(opt);
  });
}

    async function enrolarDispositivo() {
  try {
    const imei = document.getElementById('imei').value.trim();
    const nombre = document.getElementById('cliente-nombre').value.trim();
    const cedula = document.getElementById('cliente-cedula').value.trim();
    const telefono = document.getElementById('cliente-telefono').value.trim();
    const modelo = obtenerDatosModelo();
const msg = document.getElementById('enrolamiento-msg');

const { data: lotes } = await supabase
  .from('lotes')
  .select('cantidad_total, cantidad_usada')
  .eq('comercio_id', comercio_id);

const disponibles = lotes.reduce((acc, l) => acc + (l.cantidad_total - l.cantidad_usada), 0);
if (disponibles <= 0) {
  msg.textContent = "No hay licencias disponibles para este comercio.";
  return;
}

if (!imei || !nombre || !cedula || !telefono) {
  msg.textContent = "Todos los campos son obligatorios.";
  return;
}

    const payload = {
      imei,
      nombre,
      cedula,
      telefono,
      vendedor_id,
      comercio_id,
      fuente_modelo: modelo.fuente,
      modelo_id: modelo.modelo_id || null,
      marca_manual: modelo.marca || null,
      modelo_manual: modelo.modelo || null
    };

    const { data, error } = await supabase.rpc('enrolar_dispositivo', payload);

    if (error || !data) {
      msg.textContent = error?.message || "Error al enrolar dispositivo.";
      return;
    }

    msg.textContent = "Dispositivo enrolado exitosamente.";
setTimeout(() => { msg.textContent = ''; }, 5000);
    cargarHistorial();

    if (data.link_instalacion) {
      mostrarQR(data.link_instalacion);
    }

await supabase.from('eventos').insert({
  tipo: 'dispositivo_enrolado',
  descripcion: `IMEI ${imei} registrado por vendedor ${vendedor_id}`,
  usuario: vendedor_id,
  origen: 'panel_vendedor',
  creado_en: new Date().toISOString(),
  id_panel: 'enrolamiento',
  token: data.token
});

    // üßπ Limpieza post-registro
    document.getElementById('imei').value = '';
    document.getElementById('cliente-nombre').value = '';
    document.getElementById('cliente-cedula').value = '';
    document.getElementById('cliente-telefono').value = '';
    document.getElementById('modelo-select').value = '';
    document.getElementById('marca-manual').value = '';
    document.getElementById('modelo-manual').value = '';
  } catch (err) {
    document.getElementById('enrolamiento-msg').textContent = err.message;
  }
}

    async function cargarHistorial() {
  const { data, error } = await supabase.rpc('historial_ventas', { vendedor_id });

  if (error || !data) return;

  const tbody = document.querySelector('#tabla-ventas tbody');
  tbody.innerHTML = '';
  data.forEach(v => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${v.imei}</td>
      <td>${v.cliente_nombre}</td>
      <td>${v.modelo_texto}</td>
      <td>${v.estado}</td>
      <td>${v.fecha}</td>
    `;
    tbody.appendChild(row);
  });
}

function cerrarSesion() {
  vendedor_id = null;
  comercio_id = null;
  document.getElementById('login-section').style.display = 'block';
  document.getElementById('enrolamiento-section').style.display = 'none';
  document.getElementById('historial-section').style.display = 'none';
  document.getElementById('correo').value = '';
  document.getElementById('clave').value = '';
  document.getElementById('login-error').textContent = '';
}

function mostrarQR(link) {
  // Elimina cualquier QR anterior
  const anterior = document.getElementById('qrContainer');
  if (anterior) anterior.remove();

  // Crea el nuevo contenedor
  const contenedor = document.createElement('div');
  contenedor.id = 'qrContainer';
  contenedor.innerHTML = `
    <h3>Instalaci√≥n en el dispositivo</h3>
    <p>Escanea este c√≥digo desde el tel√©fono vendido:</p>
    <canvas id="qrCanvas"></canvas>
    <p><a href="${link}" target="_blank">${link}</a></p>
  `;
  document.getElementById('enrolamiento-section').appendChild(contenedor);

  // Genera el QR
  new QRious({
    element: document.getElementById('qrCanvas'),
    value: link,
    size: 200
  });
}
window.loginVendedor = loginVendedor;
});
</script>
</body>
</html>
