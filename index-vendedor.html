<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Vendedor</title>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f9f9f9; }
    .section { margin-bottom: 2em; }
    input, select, button { display: block; margin: 0.5em 0; padding: 0.5em; width: 100%; }
    .error-msg { color: red; font-size: 0.9em; }
    .success-msg { color: green; font-size: 0.9em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
  </style>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</head>
<body>

  <!-- üîê Login institucional -->
  <div id="login-section" class="section">
    <h2>Ingreso Vendedor</h2>
    <input type="email" id="correo" placeholder="Correo institucional" />
    <input type="password" id="clave" placeholder="Clave de acceso" />
    <button onclick="loginVendedor()">Ingresar</button>
    <p id="login-error" class="error-msg"></p>
  </div>

  <!-- üì≤ Enrolamiento de dispositivo -->
  <div id="enrolamiento-section" class="section" style="display:none;">
    <h2>Enrolar Dispositivo</h2>

    <label for="imei">IMEI</label>
    <input type="text" id="imei" placeholder="IMEI del dispositivo" />

    <label for="cliente-nombre">Nombre del cliente</label>
    <input type="text" id="cliente-nombre" placeholder="Nombre completo" />

    <label for="cliente-cedula">C√©dula</label>
    <input type="text" id="cliente-cedula" placeholder="C√©dula de identidad" />

    <label for="cliente-telefono">Tel√©fono</label>
    <input type="text" id="cliente-telefono" placeholder="Tel√©fono m√≥vil" />

    <label for="modelo-select">Modelo del tel√©fono (cat√°logo)</label>
    <select id="modelo-select">
      <option value="">-- Seleccionar modelo --</option>
    </select>

    <label for="marca-manual">Marca (manual)</label>
    <input type="text" id="marca-manual" placeholder="Ej: Xiaomi" />

    <label for="modelo-manual">Modelo (manual)</label>
    <input type="text" id="modelo-manual" placeholder="Ej: Redmi Note 13" />

    <button onclick="enrolarDispositivo()">Registrar venta</button>
    <p id="enrolamiento-msg" class="success-msg"></p>
  </div>

  <!-- üìã Historial de ventas -->
  <div id="historial-section" class="section" style="display:none;">
    <h2>Historial de Ventas</h2>
    <table id="tabla-ventas">
      <thead>
        <tr>
          <th>IMEI</th>
          <th>Cliente</th>
          <th>Modelo</th>
          <th>Estado</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

<button onclick="cerrarSesion()" style="margin-top:1em; background:#e74c3c; color:white; border:none; padding:0.5em; border-radius:4px;">
  Cerrar sesi√≥n
</button>
  </div>

  <script>
    let vendedor_id = null;
    let comercio_id = null;

    async function loginVendedor() {
      const correo = document.getElementById('correo').value.trim();
      const clave = document.getElementById('clave').value.trim();
      const errorMsg = document.getElementById('login-error');

      const res = await fetch('/rpc/validar_login_vendedor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo, clave })
      });

      const data = await res.json();

      if (data.length === 0) {
        errorMsg.textContent = "Credenciales inv√°lidas o vendedor inactivo.";
        return;
      }

      vendedor_id = data[0].id;
      comercio_id = data[0].comercio_id;

      document.getElementById('login-section').style.display = 'none';
      document.getElementById('enrolamiento-section').style.display = 'block';
      document.getElementById('historial-section').style.display = 'block';

      cargarCatalogo();
      cargarHistorial();
    }

    async function cargarCatalogo() {
      const res = await fetch(`/rpc/obtener_catalogo?comercio_id=${comercio_id}`);
      const modelos = await res.json();
      const select = document.getElementById('modelo-select');
      modelos.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = `${m.marca} ${m.modelo}`;
        select.appendChild(opt);
      });
    }

    function obtenerDatosModelo() {
      const modeloCatalogo = document.getElementById('modelo-select').value;
      const marcaManual = document.getElementById('marca-manual').value.trim();
      const modeloManual = document.getElementById('modelo-manual').value.trim();

      if (modeloCatalogo) {
        return { fuente: 'catalogo', modelo_id: modeloCatalogo };
      }

      if (!marcaManual || !modeloManual) {
        throw new Error("Debes ingresar marca y modelo manual si no usas el cat√°logo.");
      }

      return {
        fuente: 'manual',
        marca: marcaManual,
        modelo: modeloManual
      };
    }

    async function enrolarDispositivo() {
  try {
    const imei = document.getElementById('imei').value.trim();
    const nombre = document.getElementById('cliente-nombre').value.trim();
    const cedula = document.getElementById('cliente-cedula').value.trim();
    const telefono = document.getElementById('cliente-telefono').value.trim();
    const modelo = obtenerDatosModelo();

    const payload = {
      imei,
      nombre,
      cedula,
      telefono,
      vendedor_id,
      comercio_id,
      fuente_modelo: modelo.fuente,
      modelo_id: modelo.modelo_id || null,
      marca_manual: modelo.marca || null,
      modelo_manual: modelo.modelo || null
    };

    const res = await fetch('/rpc/enrolar_dispositivo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    const msg = document.getElementById('enrolamiento-msg');

    if (result.error) {
      msg.textContent = result.error;
    } else {
      msg.textContent = "Dispositivo enrolado exitosamente.";
      cargarHistorial();

      if (result.link_instalacion) {
        mostrarQR(result.link_instalacion);
      }

      // üßπ Limpieza post-registro
      document.getElementById('imei').value = '';
      document.getElementById('cliente-nombre').value = '';
      document.getElementById('cliente-cedula').value = '';
      document.getElementById('cliente-telefono').value = '';
      document.getElementById('modelo-select').value = '';
      document.getElementById('marca-manual').value = '';
      document.getElementById('modelo-manual').value = '';
    }
  } catch (err) {
    document.getElementById('enrolamiento-msg').textContent = err.message;
  }
}

    async function cargarHistorial() {
      const res = await fetch(`/rpc/historial_ventas?vendedor_id=${vendedor_id}`);
      const ventas = await res.json();
      const tbody = document.querySelector('#tabla-ventas tbody');
      tbody.innerHTML = '';
      ventas.forEach(v => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${v.imei}</td>
          <td>${v.cliente_nombre}</td>
          <td>${v.modelo_texto}</td>
          <td>${v.estado}</td>
          <td>${v.fecha}</td>
        `;
        tbody.appendChild(row);
      });
    }

function cerrarSesion() {
  vendedor_id = null;
  comercio_id = null;
  document.getElementById('login-section').style.display = 'block';
  document.getElementById('enrolamiento-section').style.display = 'none';
  document.getElementById('historial-section').style.display = 'none';
  document.getElementById('correo').value = '';
  document.getElementById('clave').value = '';
  document.getElementById('login-error').textContent = '';
}

function mostrarQR(link) {
  // Elimina cualquier QR anterior
  const anterior = document.getElementById('qrContainer');
  if (anterior) anterior.remove();

  // Crea el nuevo contenedor
  const contenedor = document.createElement('div');
  contenedor.id = 'qrContainer';
  contenedor.innerHTML = `
    <h3>Instalaci√≥n en el dispositivo</h3>
    <p>Escanea este c√≥digo desde el tel√©fono vendido:</p>
    <canvas id="qrCanvas"></canvas>
    <p><a href="${link}" target="_blank">${link}</a></p>
  `;
  document.getElementById('enrolamiento-section').appendChild(contenedor);

  // Genera el QR
  new QRious({
    element: document.getElementById('qrCanvas'),
    value: link,
    size: 200
  });
}
  </script>

</body>
</html>