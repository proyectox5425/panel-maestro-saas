<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel del Comercio</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    .modulo { margin-bottom: 2rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    input, button { margin: 0.3rem; padding: 0.4rem; }
  </style>
</head>
<body>
  <h2>üì¶ Panel del Comercio</h2>

  <!-- üîê Login -->
  <section class="modulo">
    <h3>Acceso institucional</h3>
    <input type="email" id="correoLogin" placeholder="Correo del comercio" />
    <input type="password" id="claveLogin" placeholder="Clave asignada" />
    <button onclick="loginComercio()">Ingresar</button>
    <div id="feedbackLogin"></div>
  </section>

  <!-- üì¶ Cat√°logo de productos -->
  <section class="modulo" id="moduloCatalogo" style="display:none;">
    <h3>Cat√°logo de Productos</h3>
    <table>
      <thead><tr><th>Marca</th><th>Modelo</th><th>Precio</th><th>Condiciones</th></tr></thead>
      <tbody id="tablaCatalogo"></tbody>
    </table>

    <h3>üì¶ Agregar producto</h3>
<input type="text" id="nombreProducto" placeholder="Nombre del producto">
<input type="number" id="precioProducto" placeholder="Precio">
<button onclick="agregarProducto()">Agregar</button>
<p id="feedbackProducto"></p>

    <h3>üìã Cat√°logo de productos</h3>
<table>
  <thead><tr><th>Nombre</th><th>Precio</th><th>Estado</th></tr></thead>
  <tbody id="tablaProductos"></tbody>
</table>

    <h3>üìã Cat√°logo de productos</h3>
<table>
  <thead>
    <tr><th>Nombre</th><th>Precio</th><th>Estado</th><th>Acci√≥n</th></tr>
  </thead>
  <tbody id="tablaProductos"></tbody>
</table>

    <h3>üí∞ Registrar venta</h3>
<select id="selectVendedor"></select>
<select id="selectProducto"></select>
<input type="number" id="montoVenta" placeholder="Monto">
<button onclick="registrarVenta()">Registrar</button>
<p id="feedbackVenta"></p>

    <h3>üìä Resumen por vendedor</h3>
<table>
  <thead><tr><th>Vendedor</th><th>Total vendido</th></tr></thead>
  <tbody id="resumenVendedor"></tbody>
</table>

<h3>üì¶ Resumen por producto</h3>
<table>
  <thead><tr><th>Producto</th><th>Total vendido</th></tr></thead>
  <tbody id="resumenProducto"></tbody>
</table>
  </section>

  <!-- üé´ Licencias asignadas -->
  <section class="modulo" id="moduloLicencias" style="display:none;">
    <h3>Licencias Asignadas</h3>
    <table>
      <thead><tr><th>IMEI</th><th>Estado</th><th>Fecha</th><th>Acci√≥n</th></tr></thead>
      <tbody id="tablaLicencias"></tbody>
    </table>
  </section>

  <!-- üí≥ M√≥dulo financiero -->
<section class="modulo" id="moduloFinanciero" style="display:none;">
  <h3>Pagos y Validaci√≥n Financiera</h3>

  <table>
    <thead><tr><th>IMEI</th><th>Monto</th><th>Fecha</th><th>Estado</th><th>Acci√≥n</th></tr></thead>
    <tbody id="tablaPagos"></tbody>
  </table>

  <h4>Registrar nuevo pago</h4>
  <input type="text" id="imeiPago" placeholder="IMEI del dispositivo" />
  <input type="number" id="montoPago" placeholder="Monto en USD" />
  <button onclick="registrarPago()">Registrar</button>
  <div id="feedbackPago"></div>
</section>

  <!-- üßë‚Äçüíº M√≥dulo de vendedores -->
<section class="modulo" id="moduloVendedores" style="display:none;">
  <h3>Gesti√≥n de Vendedores</h3>

  <table>
    <thead><tr><th>Correo</th><th>Nombre</th><th>Licencias asignadas</th><th>Acci√≥n</th></tr></thead>
    <tbody id="tablaVendedores"></tbody>
  </table>

  <h4>Registrar nuevo vendedor</h4>
  <input type="email" id="correoVendedor" placeholder="Correo institucional" />
  <input type="text" id="nombreVendedor" placeholder="Nombre completo" />
  <input type="password" id="claveVendedor" placeholder="Clave temporal" />
  <button onclick="registrarVendedor()">Registrar</button>
  <div id="feedbackVendedor"></div>
</section>

  <script>
    const supabase = supabase.createClient('TU_URL', 'TU_API_KEY');
    let comercio_id = null;

    async function loginComercio() {
      const correo = document.getElementById('correoLogin').value.trim();
      const clave = document.getElementById('claveLogin').value.trim();
      const feedback = document.getElementById('feedbackLogin');

      const { data, error } = await supabase
        .from('usuarios_comercio')
        .select('comercio_id')
        .eq('correo', correo)
        .eq('clave', clave)
        .single();

      if (error || !data) {
        feedback.textContent = '‚ùå Credenciales incorrectas';
        feedback.style.color = 'red';
        return;
      }

      comercio_id = data.comercio_id;
      feedback.textContent = '‚úÖ Acceso concedido';
      feedback.style.color = 'green';

      document.getElementById('moduloCatalogo').style.display = 'block';
      document.getElementById('moduloLicencias').style.display = 'block';
      document.getElementById('moduloFinanciero').style.display = 'block';
      document.getElementById('moduloVendedores').style.display = 'block';

      await supabase.from('eventos_dispositivo').insert({
  tipo_evento: 'login_comercio',
  usuario: correo,
  fecha: new Date().toISOString()
});

      cargarVendedores();
      cargarPagos();
      cargarCatalogo();
      cargarLicencias();
    }

    async function cargarCatalogo() {
      const { data } = await supabase
        .from('catalogo')
        .select('*')
        .eq('comercio_id', comercio_id);

      const tbody = document.getElementById('tablaCatalogo');
      tbody.innerHTML = '';
      data.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.marca}</td><td>${p.modelo}</td><td>$${p.precio}</td><td>${p.condiciones}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function cargarLicencias() {
      const { data } = await supabase
        .from('licencias')
        .select('imei, estado, fecha_creacion')
        .eq('comercio_id', comercio_id)
        .order('fecha_creacion', { ascending: false });

      const tbody = document.getElementById('tablaLicencias');
      tbody.innerHTML = '';
      data.forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${l.imei || '-'}</td>
          <td>${l.estado}</td>
          <td>${new Date(l.fecha_creacion).toLocaleString()}</td>
          <td>
            ${l.estado === 'bloqueado' ? 
              `<button onclick="desbloquear('${l.imei}')">Desbloquear</button>` :
              `<button onclick="bloquear('${l.imei}')">Bloquear</button>`}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function bloquear(imei) {
  if (!confirm(`¬øConfirmar bloqueo del IMEI ${imei}?`)) return;

  await supabase.from('licencias').update({ estado: 'bloqueado' }).eq('imei', imei);
  await supabase.from('eventos_dispositivo').insert({ imei, tipo_evento: 'bloqueo', fecha: new Date().toISOString() });
  cargarLicencias();
}

async function desbloquear(imei) {
  if (!confirm(`¬øConfirmar desbloqueo del IMEI ${imei}?`)) return;

  await supabase.from('licencias').update({ estado: 'activa' }).eq('imei', imei);
  await supabase.from('eventos_dispositivo').insert({ imei, tipo_evento: 'desbloqueo_manual', fecha: new Date().toISOString() });
  cargarLicencias();
}

    async function cargarPagos() {
  const { data } = await supabase
    .from('pagos_licencia')
    .select('imei, monto, fecha_pago, estado')
    .eq('comercio_id', comercio_id)
    .order('fecha_pago', { ascending: false });

  const tbody = document.getElementById('tablaPagos');
  tbody.innerHTML = '';
  data.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.imei}</td>
      <td>$${p.monto}</td>
      <td>${new Date(p.fecha_pago).toLocaleString()}</td>
      <td>${p.estado}</td>
      <td>
        ${p.estado === 'pendiente' ? 
          `<button onclick="validarPago('${p.imei}')">Validar</button>` :
          `<span>‚úîÔ∏è</span>`}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function registrarPago() {
  const imei = document.getElementById('imeiPago').value.trim();
  const monto = parseFloat(document.getElementById('montoPago').value);
  const feedback = document.getElementById('feedbackPago');

  if (!imei || isNaN(monto)) {
    feedback.textContent = '‚ùå Datos incompletos';
    feedback.style.color = 'red';
    return;
  }

  await supabase.from('pagos_licencia').insert({
    imei,
    monto,
    fecha_pago: new Date().toISOString(),
    estado: 'pendiente',
    comercio_id
  });

  feedback.textContent = '‚úÖ Pago registrado';
  feedback.style.color = 'green';
  cargarPagos();
}

async function validarPago(imei) {
  // Validar el pago
  await supabase.from('pagos_licencia')
    .update({ estado: 'validado' })
    .eq('imei', imei);

  // Registrar evento
  await supabase.from('eventos_dispositivo').insert({
    imei,
    tipo_evento: 'pago_validado',
    fecha: new Date().toISOString()
  });

  // Verificar si el dispositivo est√° bloqueado
  const { data } = await supabase
    .from('licencias')
    .select('estado')
    .eq('imei', imei)
    .single();

  if (data && data.estado === 'bloqueado') {
    // Desbloquear autom√°ticamente
    await supabase.from('licencias').update({ estado: 'activa' }).eq('imei', imei);
    await supabase.from('eventos_dispositivo').insert({
      imei,
      tipo_evento: 'desbloqueo_automatico',
      fecha: new Date().toISOString()
    });
  }

  cargarPagos();
  cargarLicencias();
    }

    async function cargarVendedores() {
  const { data } = await supabase
    .from('vendedores')
    .select('correo, nombre, vendedor_id')
    .eq('comercio_id', comercio_id);

  const tbody = document.getElementById('tablaVendedores');
  tbody.innerHTML = '';

  for (const v of data) {
    const { data: licencias } = await supabase
      .from('licencias')
      .select('id')
      .eq('vendedor_id', v.vendedor_id);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${v.correo}</td>
      <td>${v.nombre}</td>
      <td>${licencias.length}</td>
      <td><button onclick="asignarLicencia('${v.vendedor_id}')">Asignar licencia</button></td>
    `;
    tbody.appendChild(tr);
  }
}

async function registrarVendedor() {
  const correo = document.getElementById('correoVendedor').value.trim();
  const nombre = document.getElementById('nombreVendedor').value.trim();
  const clave = document.getElementById('claveVendedor').value.trim();
  const feedback = document.getElementById('feedbackVendedor');

  if (!correo || !nombre || !clave) {
    feedback.textContent = '‚ùå Datos incompletos';
    feedback.style.color = 'red';
    return;
  }

  const { data: existente } = await supabase
    .from('vendedores')
    .select('correo')
    .eq('correo', correo)
    .single();

  if (existente) {
    feedback.textContent = '‚ùå Correo ya registrado';
    feedback.style.color = 'red';
    return;
  }

  await supabase.from('vendedores').insert({
    correo, nombre, clave, comercio_id
  });

  feedback.textContent = '‚úÖ Vendedor registrado';
  feedback.style.color = 'green';
  cargarVendedores();
    }

async function asignarLicencia(vendedor_id) {
  const imei = prompt('IMEI a asignar:');
  if (!imei) return;

  await supabase.from('licencias')
    .update({ vendedor_id })
    .eq('imei', imei);

  await supabase.from('eventos_dispositivo').insert({
    imei,
    tipo_evento: 'asignacion_vendedor',
    vendedor_id,
    fecha: new Date().toISOString()
  });

  cargarVendedores();
  }

    async function agregarProducto() {
  const nombre = document.getElementById('nombreProducto').value.trim();
  const precio = parseFloat(document.getElementById('precioProducto').value);
  const feedback = document.getElementById('feedbackProducto');

  if (!nombre || isNaN(precio) || precio <= 0) {
    feedback.textContent = '‚ùå Datos inv√°lidos';
    feedback.style.color = 'red';
    return;
  }

  await supabase.from('productos_comercio').insert({
    comercio_id,
    nombre,
    precio,
    activo: true,
    fecha_creado: new Date().toISOString()
  });

  feedback.textContent = '‚úÖ Producto agregado';
  feedback.style.color = 'green';
  document.getElementById('nombreProducto').value = '';
  document.getElementById('precioProducto').value = '';
  cargarProductos(); // si ten√©s una tabla visual
      }

    async function cargarProductos() {
  const { data: productos } = await supabase
    .from('productos_comercio')
    .select('*')
    .eq('comercio_id', comercio_id)
    .order('fecha_creado', { ascending: false });

  const contenedor = document.getElementById('tablaProductos');
  contenedor.innerHTML = productos.map(p => `
    <tr>
      <td>${p.nombre}</td>
      <td>${p.precio}</td>
      <td>${p.activo ? 'üü¢' : 'üî¥'}</td>
    </tr>
  `).join('');
    }

    async function toggleProducto(id, estadoActual) {
  const nuevoEstado = !estadoActual;
  const confirmacion = confirm(`¬øConfirmar ${nuevoEstado ? 'activaci√≥n' : 'desactivaci√≥n'} del producto?`);
  if (!confirmacion) return;

  await supabase.from('productos_comercio')
    .update({ activo: nuevoEstado })
    .eq('id', id);

  await supabase.from('eventos_dispositivo').insert({
    tipo_evento: nuevoEstado ? 'producto_activado' : 'producto_desactivado',
    producto_id: id,
    fecha: new Date().toISOString()
  });

  cargarProductos();
    }

    async function registrarVenta() {
  const vendedor_id = document.getElementById('selectVendedor').value;
  const producto_id = document.getElementById('selectProducto').value;
  const monto = parseFloat(document.getElementById('montoVenta').value);
  const feedback = document.getElementById('feedbackVenta');

  if (!vendedor_id || !producto_id || isNaN(monto) || monto <= 0) {
    feedback.textContent = '‚ùå Datos inv√°lidos';
    feedback.style.color = 'red';
    return;
  }

  await supabase.from('ventas_comercio').insert({
    comercio_id,
    vendedor_id,
    producto_id,
    monto,
    fecha_venta: new Date().toISOString()
  });

  feedback.textContent = '‚úÖ Venta registrada';
  feedback.style.color = 'green';
  document.getElementById('montoVenta').value = '';
  cargarVentas(); // si ten√©s tabla visual
    }

    async function cargarSelectoresVenta() {
  const { data: vendedores } = await supabase
    .from('vendedores')
    .select('id, nombre')
    .eq('comercio_id', comercio_id);

  const { data: productos } = await supabase
    .from('productos_comercio')
    .select('id, nombre')
    .eq('comercio_id', comercio_id)
    .eq('activo', true);

  const selectVendedor = document.getElementById('selectVendedor');
  const selectProducto = document.getElementById('selectProducto');

  selectVendedor.innerHTML = vendedores.map(v => `<option value="${v.id}">${v.nombre}</option>`).join('');
  selectProducto.innerHTML = productos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
    }

    async function resumenPorVendedor() {
  const { data: ventas } = await supabase
    .from('ventas_comercio')
    .select('vendedor_id, monto, vendedores(nombre)')
    .eq('comercio_id', comercio_id);

  const resumen = {};

  ventas.forEach(v => {
    const nombre = v.vendedores?.nombre || 'Sin nombre';
    if (!resumen[nombre]) resumen[nombre] = 0;
    resumen[nombre] += v.monto;
  });

  const contenedor = document.getElementById('resumenVendedor');
  contenedor.innerHTML = Object.entries(resumen).map(([nombre, total]) => `
    <tr><td>${nombre}</td><td>${total.toFixed(2)}</td></tr>
  `).join('');
    }

    async function resumenPorProducto() {
  const { data: ventas } = await supabase
    .from('ventas_comercio')
    .select('producto_id, monto, productos_comercio(nombre)')
    .eq('comercio_id', comercio_id);

  const resumen = {};

  ventas.forEach(v => {
    const nombre = v.productos_comercio?.nombre || 'Sin nombre';
    if (!resumen[nombre]) resumen[nombre] = 0;
    resumen[nombre] += v.monto;
  });

  const contenedor = document.getElementById('resumenProducto');
  contenedor.innerHTML = Object.entries(resumen).map(([nombre, total]) => `
    <tr><td>${nombre}</td><td>${total.toFixed(2)}</td></tr>
  `).join('');
    }
  </script>
</body>
  </html>
